<div id="admin-table" class="card p-5">
  {% set admin_perm = request.state.permission_flags.admin_users %}
  {% set show_action_col = admin_perm['update'] or admin_perm['delete'] %}
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div>
      <h2 class="text-lg font-semibold text-slate-900">管理员列表</h2>
      <p class="mt-1 text-sm text-slate-500">共 {{ pagination.total }} 条记录</p>
    </div>

    <div class="flex items-center gap-2">
      <button
        class="btn-ghost"
        hx-get="/admin/users/table"
        hx-target="#admin-table"
        hx-swap="outerHTML"
        hx-indicator="#global-indicator"
        hx-vals='{{ {"search_q": filters.search_q, "search_role": filters.search_role, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.page}|tojson }}'
      >
        刷新
      </button>
      {% if admin_perm['create'] %}
        <button
          class="btn-primary"
          hx-get="/admin/users/new"
          hx-target="#modal-body"
          hx-swap="innerHTML"
          hx-indicator="#global-indicator"
          hx-vals='{{ {"search_q": filters.search_q, "search_role": filters.search_role, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.page}|tojson }}'
          x-on:click="modalOpen = true"
        >
          新建管理员
        </button>
      {% endif %}
    </div>
  </div>

  {% if items %}
    <div class="mt-4 overflow-x-auto rounded-lg border border-slate-200">
      <table class="w-full min-w-[1050px] text-left text-sm">
        <thead class="bg-slate-50 text-slate-600">
          <tr>
            <th class="px-4 py-3 font-medium">账号</th>
            <th class="px-4 py-3 font-medium">角色</th>
            <th class="px-4 py-3 font-medium">邮箱</th>
            <th class="px-4 py-3 font-medium">状态</th>
            <th class="px-4 py-3 font-medium">最后登录</th>
            <th class="px-4 py-3 font-medium">更新时间</th>
            {% if show_action_col %}<th class="px-4 py-3 text-right font-medium">操作</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for item in items %}
            {% set meta = status_meta[item.status] %}
            <tr class="border-t border-slate-100">
              <td class="px-4 py-3">
                <div class="font-medium text-slate-900">{{ item.display_name }}</div>
                <div class="text-xs text-slate-500">{{ item.username }}</div>
              </td>
              <td class="px-4 py-3">
                <span class="tag">{{ role_map.get(item.role_slug, item.role_slug) }}</span>
              </td>
              <td class="px-4 py-3 text-slate-500">{{ item.email or "-" }}</td>
              <td class="px-4 py-3">
                <span class="tag" style="border-color: {{ meta.color }}; color: {{ meta.color }};">
                  {{ meta.label }}
                </span>
              </td>
              <td class="px-4 py-3 text-slate-500">{{ item.last_login | fmt_dt }}</td>
              <td class="px-4 py-3 text-slate-500">{{ item.updated_at | fmt_dt }}</td>
              {% if show_action_col %}
                <td class="px-4 py-3 text-right">
                  {% if admin_perm['update'] %}
                    <button
                      class="btn-link"
                      hx-get="/admin/users/{{ item.id }}/edit"
                      hx-target="#modal-body"
                      hx-swap="innerHTML"
                      hx-indicator="#global-indicator"
                      hx-vals='{{ {"search_q": filters.search_q, "search_role": filters.search_role, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.page}|tojson }}'
                      x-on:click="modalOpen = true"
                    >
                      编辑
                    </button>
                  {% endif %}
                  {% if admin_perm['delete'] %}
                    <button
                      class="btn-link {% if admin_perm['update'] %}ml-3 {% endif %}text-red-500 hover:text-red-600"
                      hx-delete="/admin/users/{{ item.id }}"
                      hx-target="#admin-table"
                      hx-swap="outerHTML"
                      hx-confirm="确认删除该管理员吗？"
                      hx-indicator="#global-indicator"
                      hx-vals='{{ {"search_q": filters.search_q, "search_role": filters.search_role, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.page}|tojson }}'
                    >
                      删除
                    </button>
                  {% endif %}
                </td>
              {% endif %}
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  {% else %}
    <div class="mt-4 rounded-lg border border-dashed border-slate-200 bg-slate-50/70 p-10 text-center">
      <p class="text-lg font-semibold text-slate-800">暂无管理员账号</p>
      <p class="mt-2 text-sm text-slate-500">点击右上角“新建管理员”创建第一个账号。</p>
    </div>
  {% endif %}

  <div class="mt-4 flex flex-wrap items-center justify-between gap-3 border-t border-slate-100 pt-4">
    <p class="text-xs text-slate-500">显示 {{ pagination.start_item }} - {{ pagination.end_item }} / {{ pagination.total }}</p>

    <div class="flex flex-wrap items-center gap-2">
      <button
        class="btn-ghost px-3 {% if not pagination.has_prev %}opacity-50 pointer-events-none{% endif %}"
        hx-get="/admin/users/table"
        hx-target="#admin-table"
        hx-swap="outerHTML"
        hx-indicator="#global-indicator"
        hx-vals='{{ {"search_q": filters.search_q, "search_role": filters.search_role, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.prev_page}|tojson }}'
        {% if not pagination.has_prev %}disabled{% endif %}
      >
        上一页
      </button>
      {% for p in pagination.pages %}
        <button
          class="{% if p == pagination.page %}btn-primary{% else %}btn-ghost{% endif %} px-3"
          hx-get="/admin/users/table"
          hx-target="#admin-table"
          hx-swap="outerHTML"
          hx-indicator="#global-indicator"
          hx-vals='{{ {"search_q": filters.search_q, "search_role": filters.search_role, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": p}|tojson }}'
        >
          {{ p }}
        </button>
      {% endfor %}
      <button
        class="btn-ghost px-3 {% if not pagination.has_next %}opacity-50 pointer-events-none{% endif %}"
        hx-get="/admin/users/table"
        hx-target="#admin-table"
        hx-swap="outerHTML"
        hx-indicator="#global-indicator"
        hx-vals='{{ {"search_q": filters.search_q, "search_role": filters.search_role, "search_status": filters.search_status, "search_sort": filters.search_sort, "page": pagination.next_page}|tojson }}'
        {% if not pagination.has_next %}disabled{% endif %}
      >
        下一页
      </button>
    </div>
  </div>
</div>
