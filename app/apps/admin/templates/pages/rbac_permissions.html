{% extends "base.html" %}

{% block content %}
<div class="mx-auto max-w-5xl px-4 pb-16 pt-10 md:px-8">
  <div class="card p-6 md:p-8">
    <div class="flex items-start justify-between gap-4">
      <div>
        <h1 class="font-display text-3xl text-ink">权限树配置</h1>
        <p class="mt-2 text-sm text-muted">按功能树为角色配置“增删改查”权限。</p>
      </div>
      <div class="chip">RBAC Tree</div>
    </div>

    {% if error %}
      <div class="mt-4 rounded-2xl border border-black/10 bg-white/70 p-3 text-sm text-red-600">
        {{ error }}
      </div>
    {% endif %}

    {% if saved %}
      <div class="mt-4 rounded-2xl border border-black/10 bg-white/70 p-3 text-sm text-[rgb(var(--accent-cool))]">
        权限配置已保存。
      </div>
    {% endif %}

    <form class="mt-6 grid gap-6" method="post" action="/admin/rbac/permissions">
      <div class="grid gap-4 md:grid-cols-2">
        <div>
          <label class="label">角色标识</label>
          <input name="role_key" class="input" value="{{ role_key }}" required list="role_keys" />
          <datalist id="role_keys">
            {% for item in role_choices %}
              <option value="{{ item.key }}"></option>
            {% endfor %}
          </datalist>
        </div>
        <div>
          <label class="label">角色名称</label>
          <input name="role_name" class="input" value="{{ role_name }}" required />
        </div>
      </div>

      <div class="space-y-5">
        {% for group in tree %}
          <div class="rounded-2xl border border-black/10 bg-white/80 p-4">
            <div class="flex items-center gap-3">
              <div class="h-2 w-2 rounded-full bg-ink"></div>
              <p class="text-sm font-semibold text-ink">{{ group.name }}</p>
            </div>
            <div class="mt-4 space-y-4 border-l border-black/10 pl-6">
              {% for node in group.children %}
                <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
                  <div>
                    <p class="text-sm font-semibold text-ink">{{ node.name }}</p>
                    <p class="text-xs text-muted">{{ node.url }}</p>
                  </div>
                  <div class="flex flex-wrap gap-2">
                    {% for action in node.actions %}
                      <label class="flex items-center gap-2 rounded-full border border-black/10 px-3 py-1 text-xs font-medium text-ink">
                        <input
                          type="checkbox"
                          name="perm_{{ node.key }}"
                          value="{{ action }}"
                          {% if action in checked_map.get(node.key, []) %}checked{% endif %}
                        />
                        {{ action_labels[action] }}
                      </label>
                    {% endfor %}
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        {% endfor %}
      </div>

      <button type="submit" class="btn-primary">保存权限</button>
    </form>
  </div>
</div>
{% endblock %}
